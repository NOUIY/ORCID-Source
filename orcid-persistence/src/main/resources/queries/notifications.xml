<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
    <comment>Select unsent notifications</comment>
	<entry key="notifications.unsent"><![CDATA[
	WITH user_freq AS (
	    SELECT 
	        (send_change_notifications * 86400) AS amend_freq,
	        (send_administrative_change_notifications * 86400) AS admin_freq,
	        (send_member_update_requests * 86400) AS perm_freq
	    FROM email_frequency 
	    WHERE orcid = :orcid
	),
	user_sent_stats AS (
	    SELECT 
	        MAX(sent_date) FILTER (WHERE notification_type = 'AMENDED') AS amend_max,
	        MAX(sent_date) FILTER (WHERE notification_type IN ('ADMINISTRATIVE', 'CUSTOM')) AS admin_max,
	        MAX(sent_date) FILTER (WHERE notification_type IN ('PERMISSION', 'INSTITUTIONAL_CONNECTION')) AS perm_max
	    FROM notification 
	    WHERE orcid = :orcid
	)
	SELECT n.* FROM notification n
	CROSS JOIN user_freq f
	CROSS JOIN user_sent_stats s
	WHERE n.orcid = :orcid 
	  AND n.sent_date IS NULL 
	  AND (
	    (n.notification_type IN ('ADMINISTRATIVE', 'CUSTOM')
	        AND (
	            unix_timestamp(:effective_date) > (unix_timestamp(s.admin_max) + f.admin_freq)
	            OR (s.admin_max IS NULL AND unix_timestamp(:effective_date) > (unix_timestamp(:record_active_date) + f.admin_freq))
	        )       
	    )
	    OR
	    (n.notification_type = 'AMENDED' 
	        AND ( 
	            unix_timestamp(:effective_date) > (unix_timestamp(s.amend_max) + f.amend_freq)
	            OR (s.amend_max IS NULL AND unix_timestamp(:effective_date) > (unix_timestamp(:record_active_date) + f.amend_freq))
	        )
	    )
	    OR
	    (n.notification_type IN ('PERMISSION', 'INSTITUTIONAL_CONNECTION') 
	        AND (
	            unix_timestamp(:effective_date) > (unix_timestamp(s.perm_max) + f.perm_freq)
	            OR (s.perm_max IS NULL AND unix_timestamp(:effective_date) > (unix_timestamp(:record_active_date) + f.perm_freq))
	        )       
	    )   
	  );
	    ]]></entry>
</properties>